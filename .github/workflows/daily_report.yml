name: Daily AI Report

on:
    schedule:
        # Runs at 02:00 UTC everyday (10:00 AM Beijing Time)
        - cron: "0 2 * * *"
    workflow_dispatch:
        inputs:
            target_date:
                description: "Date to generate report for (YYYY-MM-DD)"
                required: false
                default: ""

permissions:
    contents: write # Allow pushing back to repo

jobs:
    build:
        runs-on: ubuntu-latest
        env:
            TZ: "Asia/Shanghai" # Set timezone to Beijing Time

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.9"

            - name: Install dependencies
              run: |
                  pip install requests

            - name: Configure Git for Push
              run: |
                  git config --global user.name "AI Agent Bot"
                  git config --global user.email "bot@example.com"
                  # Authenticate using the GITHUB_TOKEN provided automatically by GitHub
                  git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

            - name: Run Daily Report Script
              env:
                  NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
                  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
                  FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
                  DATABASE_ID: ${{ secrets.DATABASE_ID }}
              run: |
                  # Determine date argument
                  if [ -n "${{ github.event.inputs.target_date }}" ]; then
                    DATE_ARG="--date ${{ github.event.inputs.target_date }}"
                  else
                    DATE_ARG=""
                  fi

                  # Run script (Repo root contains the script)
                  python notion_daily_report.py $DATE_ARG

      - name: Sync Annotations (Optional)
        env:
          HYPOTHESIS_TOKEN: ${{ secrets.HYPOTHESIS_TOKEN }}
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_NOTES_DB_ID: ${{ secrets.NOTION_NOTES_DB_ID }}
        run: |
          # This script handles its own graceful exit if secrets are missing
          python sync_hypothesis.py
